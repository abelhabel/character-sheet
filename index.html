<!DOCTYPE html>
<html>
<head>

</head>
<body>

</body>
<script>
class Module {
  constructor(name) {
    this.name = name;
    this.module = '';
    Module.modules[name] = this;
  }

  get exports() {
    return this.module;
  }

  set exports(n) {
    this.module = n;
    // Module.loaders.forEach(l => l());
  }

  static onLoad(files, fn) {
    console.log('load modules')
    var o = Promise.resolve();
    files.forEach(f => {
      let tag = f.match('.js') ? 'script' : 'img';
      o = o.then(() => {
        return new Promise((resolve, reject) => {
          var script = document.createElement(tag);
          script.onload = function() {
            if(tag == 'img') {
              let m = new Module(f);
              m.exports = script;
            }
            resolve();
          };
          script.src = f;
          tag == 'script' && document.body.appendChild(script);
        })
      })
    })
    o.then(function() {
      fn()
    }).catch(e => {
      console.log('loading error', e)
    });
  }
}

function require(name) {
  return Module.modules[name] && Module.modules[name].module || null;
}
Module.modules = {};
Module.loaders = [];
  Module.onLoad(['DungeonCrawl_ProjectUtumnoTileset.png',
  'abilities.js', 'monsters.js', 'terrains.js', 'icons.js','animations.js', 'seven.js',
  'Canvas.js', 'Sprite.js', 'Slider.js', 'Animation.js', 'CS.js',
  'heroes-like.js', 'animation-tpl.js', 'ability-tpl.js', 'terrain-tpl.js', 'icon-tpl.js'], () => {
    console.log('all loaded')
    const CS = require('CS.js');
    const Canvas = require('Canvas.js');
    const Sprite = require('Sprite.js');
    const Animation = require('Animation.js');
    function loadSeven() {
      const seven = require("seven.js");
      var pools = {
        bodyFaculties: 5,
        mindFaculties: 5
      };
      var cs = new CS(seven, document.body, pools);
      cs.render();
    }

    function loadHeroes() {
      let heroes = require("heroes-like.js")
      var cs = new CS(heroes, document.body);
      cs.render();
    }

    function loadAbility() {
      let ability = require("ability-tpl.js");
      var cs  = new CS(ability, document.body);
      cs.render();
    }

    function loadTerrain() {
      let terrain = require("terrain-tpl.js");
      var cs  = new CS(terrain, document.body);
      cs.render();
    }

    function loadIcons() {
      let terrain = require("icon-tpl.js");
      var cs  = new CS(terrain, document.body);
      cs.render();
    }

    function loadAnimations() {
      let spriteSelect = document.createElement('div');
      let selectedSprite;
      let abilities = require('abilities.js');
      abilities.forEach(a => {
        let s = new Sprite(a.bio.sprite);
        selectedSprite = s;
        spriteSelect.appendChild(s.canvas);
        s.canvas.addEventListener('click', e => {
          selectedSprite = s;
          animation.sprite = s;
        })
      })
      document.body.appendChild(spriteSelect);

      let w = 12;
      let h = 11;
      let tw = 42;
      let th = 42;
      var canvas = new Canvas(w * tw, h * th);
      var c = document.createElement('div');
      Object.assign(c.style, {
        position: 'fixed',
        top: '200px',
        right: '0px'
      });
      canvas.canvas.style.backgroundColor = 'slategray';
      canvas.mount(c);
      document.body.appendChild(c);
      var animation = new Animation(0, 5*th, canvas.w, 5*th, selectedSprite, {});
      animation.on('end', () => {
        console.log('animation ended')
      })
      window.animation = animation;
      let template = require("animation-tpl.js");
      var cs  = new CS(template, document.body, null, (c, i, v) => {
        // console.log(c, i, 'changed', v)
        animation[i.exportAs] = v;
      });
      cs.render();

      function move() {
        animation.move();
        canvas.clear();
        animation.draw(canvas);
        window.requestAnimationFrame(move);
      }
      move();
    }

    var url = new URL(document.location.href);
    var part = url.searchParams.get('part');

    switch(part) {
      case 'heroes':
        loadHeroes();
        break;
      case 'seven':
        loadSeven();
        break;
      case 'abilities':
        loadAbility();
        break;
      case 'terrain':
        loadTerrain();
        break;
      case 'icons':
        loadIcons();
        break;
      case 'animations':
        loadAnimations();
        break;
      default:
        loadHeroes();
        break;
    }

  })
</script>
</html>
